  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RATAN WIN - WinGo</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#111214; --panel:#1b1c20; --panel2:#23252b; --gold:#f59e0b; --gold2:#ffb321;
    --green:#22c55e; --red:#ef4444; --violet:#8b5cf6; --text:#e5e7eb;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Poppins,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{background:#17181b;padding:10px 14px;display:flex;align-items:center;justify-content:center;
         position:sticky;top:0;z-index:10;border-bottom:1px solid #2a2d34}
  .brand{font-weight:800; letter-spacing:.5px;}
  .brand .a{background:linear-gradient(90deg,#ff7e22,#25b63c);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .wallet{margin:12px;background:linear-gradient(180deg,#2b2d33,#23252b);border-radius:14px;padding:16px;
          display:flex;align-items:center;justify-content:space-between;gap:10px}
  .btn{border:none;border-radius:26px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn-red{background:#ef4444;color:white}.btn-green{background:#22c55e;color:white}
  .banner{margin:12px;background:#151515;border:1px solid #3a2b05;color:#f8e4b0;border-radius:12px;padding:12px}
  .variants{margin:12px;display:flex;gap:10px}
  .chip{flex:1;padding:12px;border-radius:14px;text-align:center;background:#2a2d34;cursor:pointer;border:1px solid transparent;font-weight:600}
  .chip.active{background:linear-gradient(180deg,#ffdd9a,#f3b13a);color:#111;border-color:#f59e0b}
  .panel{margin:12px;background:var(--panel);border-radius:16px;padding:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .timer{font-family:monospace;font-size:26px;background:#0f0f11;padding:8px 12px;border-radius:8px;letter-spacing:1px}
  .color-tabs{display:flex;gap:10px;margin:12px}
  .color-tabs .tab{flex:1;padding:12px;text-align:center;border-radius:10px;font-weight:700;cursor:pointer;background:#2a2d34}
  .tab.green{background:#184a2d;color:#9bf6bc}
  .tab.violet{background:#2b214f;color:#c7b8ff}
  .tab.red{background:#4a1b1b;color:#ffb4b4}
  .nums{margin:12px;background:#141519;border-radius:16px;padding:12px;display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .ball{aspect-ratio:1/1;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:20px;cursor:pointer;border:3px solid rgba(255,255,255,.06);box-shadow:inset 0 6px 14px rgba(0,0,0,.6)}
  .ball.red{background:radial-gradient(circle at 30% 30%,#ffb3b3,#ef4444 60%, #991b1b)}
  .ball.green{background:radial-gradient(circle at 30% 30%,#b8ffd2,#22c55e 60%, #14532d)}
  .ball.mix0{background:radial-gradient(circle at 30% 30%,#e9c7ff,#a855f7 40%, #ef4444)}
  .ball.mix5{background:radial-gradient(circle at 30% 30%,#e9c7ff,#22c55e 40%, #a855f7)}
  .stakebar{margin:12px;display:flex;gap:10px;flex-wrap:wrap}
  .tag{padding:8px 12px;border-radius:999px;background:#26282f;border:1px solid #3a3d45;cursor:pointer;font-weight:600}
  .tag.active{background:#1f8b45;border-color:#2dd26f}
  .bigsmall{margin:12px;display:flex;gap:10px}
  .big,.small{flex:1;padding:14px;border-radius:50px;font-weight:800;cursor:pointer;text-align:center}
  .big{background:linear-gradient(180deg,#ffdd9a,#f3b13a);color:#111}
  .small{background:#3b82f6}
  .tabs2{display:flex;gap:10px;margin:12px}
  .tabs2 .t{flex:1;padding:12px;text-align:center;border-radius:12px;background:#2a2d34;font-weight:700;cursor:pointer}
  .tabs2 .t.active{background:linear-gradient(180deg,#ffdd9a,#f3b13a);color:#111}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px 8px;border-bottom:1px solid #2c2f36;text-align:left}
  th{background:#3a2d11;color:#ffe0a6;position:sticky;top:0}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}.dot.red{background:#ef4444}.dot.green{background:#22c55e}.dot.violet{background:#8b5cf6}
  .pager{display:flex;align-items:center;justify-content:center;gap:12px;padding:12px}.pagebtn{padding:10px 14px;border-radius:10px;background:#2a2d34;cursor:pointer}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18%;padding:16px 18px;border-radius:18px;display:none;z-index:30}
  #betSuccess{background:rgba(0,0,0,.7);color:#fff;border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(2px)}
  #winToast{background:linear-gradient(180deg,#ffb84d,#ff8c1a);color:#111;border:2px solid #fff;box-shadow:0 8px 30px rgba(255,140,26,.45)}
  #winToast .rocket{width:20px;height:20px;margin-right:8px;vertical-align:middle}
  #loseToast{background:linear-gradient(180deg,#eef2f7,#cdd4dd);color:#111;border:2px solid #d1d5db;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;z-index:25}
  .sheet{width:100%;background:#1b1c20;border-top-left-radius:18px;border-top-right-radius:18px;padding:16px}
  .sheet.blue{border-top:6px solid #3b82f6}.sheet.orange{border-top:6px solid #f59e0b}
  .rowx{display:flex;align-items:center;gap:10px;margin:12px 0}
  .qty{display:flex;align-items:center;gap:8px}
  .qty input{width:80px;text-align:center;padding:10px;border-radius:8px;border:none;background:#0f0f12;color:#fff;font-weight:700}
  .chipx{padding:8px 12px;border-radius:10px;background:#2a2d34;cursor:pointer}
  .agree{display:flex;align-items:center;gap:8px;margin:10px 0}
  .actions{display:flex;gap:10px}.btn-ghost{flex:1;background:#2a2d34;color:#ddd}.btn-primary{flex:2;background:#3b82f6;color:#fff}
</style>
</head>
<body>
<header><div class="brand"><span class="a">RATAN WIN</span></div></header>

<section class="wallet">
  <div>
    <div style="opacity:.9">Wallet balance</div>
    <div id="balance" style="font-size:26px;font-weight:800">₹0.00</div>
  </div>
  <div style="display:flex; gap:8px">
    <button class="btn btn-red" onclick="alert('Withdraw flow TBD')">Withdraw</button>
    <button class="btn btn-green" onclick="alert('Deposit flow TBD')">Deposit</button>
  </div>
</section>

<div class="banner">Welcome to RATAN WIN game platform, we will serve you wholeheartedly!</div>

<div class="variants">
  <div class="chip active" data-variant="30">WinGo 30sec</div>
  <div class="chip" data-variant="60">WinGo 1 Min</div>
  <div class="chip" data-variant="180">WinGo 3 Min</div>
  <div class="chip" data-variant="300">WinGo 5 Min</div>
</div>

<section class="panel">
  <div class="row">
    <div style="font-weight:700">WinGo <span id="vlabel">30sec</span></div>
    <div class="row" style="gap:8px">
      <div>Time remaining</div>
      <div id="count" class="timer">00:30 sec</div>
    </div>
  </div>
  <div class="row">
    <div>Period</div>
    <div id="period" style="font-family:monospace"></div>
  </div>
</section>

<div class="color-tabs">
  <div class="tab green" onclick="openBet('COLOR','Green')">Green</div>
  <div class="tab violet" onclick="openBet('COLOR','Violet')">Violet</div>
  <div class="tab red" onclick="openBet('COLOR','Red')">Red</div>
</div>

<div class="nums" id="nums"></div>

<div class="stakebar">
  <div class="tag" data-m="RANDOM">Random</div>
  <div class="tag active" data-m="1">X1</div>
  <div class="tag" data-m="5">X5</div>
  <div class="tag" data-m="10">X10</div>
  <div class="tag" data-m="20">X20</div>
  <div class="tag" data-m="50">X50</div>
  <div class="tag" data-m="100">X100</div>
</div>

<div class="bigsmall">
  <div class="big" onclick="openBet('BS','Big')">Big</div>
  <div class="small" onclick="openBet('BS','Small')">Small</div>
</div>

<div class="tabs2">
  <div class="t active">Game history</div>
  <div class="t">Chart</div>
  <div class="t">Follow Strategy</div>
</div>

<section class="panel">
  <table id="history">
    <thead>
      <tr><th>Period</th><th>Number</th><th>Big Small</th><th>Color</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pager">
    <div class="pagebtn" onclick="prevPage()">&lt;</div>
    <div id="pageno">1/50</div>
    <div class="pagebtn" onclick="nextPage()">&gt;</div>
  </div>
</section>

<!-- Bet Modal -->
<div class="modal" id="betModal">
  <div class="sheet" id="sheet">
    <h3 id="betTitle">WinGo 30sec</h3>
    <div id="betSelection" style="margin-top:8px;font-weight:700"></div>
    <div class="rowx">
      <div style="min-width:80px">Balance</div>
      <div class="chipx" onclick="qtyMultiply(1)">1</div>
      <div class="chipx" onclick="qtyMultiply(10)">10</div>
      <div class="chipx" onclick="qtyMultiply(100)">100</div>
      <div class="chipx" onclick="qtyMultiply(1000)">1000</div>
    </div>
    <div class="rowx">
      <div style="min-width:80px">Quantity</div>
      <div class="qty">
        <button class="chipx" onclick="chgQty(-1)">-</button>
        <input id="qty" type="number" value="1" min="1">
        <button class="chipx" onclick="chgQty(1)">+</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="chipx" onclick="setX(1)">X1</div>
        <div class="chipx" onclick="setX(5)">X5</div>
        <div class="chipx" onclick="setX(10)">X10</div>
        <div class="chipx" onclick="setX(20)">X20</div>
        <div class="chipx" onclick="setX(50)">X50</div>
        <div class="chipx" onclick="setX(100)">X100</div>
      </div>
    </div>
    <div class="agree"><input id="agree" type="checkbox" checked> <label for="agree">I agree <span style="color:#f87171">《Pre-sale rules》</span></label></div>
    <div class="actions">
      <button class="btn btn-ghost" onclick="closeBet()">Cancel</button>
      <button class="btn btn-primary" id="placeBtn" onclick="placeBet()">Total amount ₹<span id="amount">1.00</span></button>
    </div>
  </div>
</div>

<!-- Popups -->
<div class="toast" id="betSuccess">✔ Bet Successful</div>
<div class="toast" id="winToast">
  <div style="display:flex;align-items:center;font-weight:800;font-size:18px">
    <svg class="rocket" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c3 0 7 3 9 5-1 2-4 6-7 7-1 3-5 6-7 7 2-2 1-5 1-5l-5-1s3-4 6-5c1-3 5-6 7-8z"/></svg>
    Congratulations
  </div>
  <div>Bonus: ₹<span id="winAmt">0.00</span></div>
  <div style="opacity:.7;margin-top:6px">3 seconds auto close</div>
</div>
<div class="toast" id="loseToast">
  <div style="display:flex;align-items:center;font-weight:800;font-size:18px">
    <svg class="rocket" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c3 0 7 3 9 5-1 2-4 6-7 7-1 3-5 6-7 7 2-2 1-5 1-5l-5-1s3-4 6-5c1-3 5-6 7-8z"/></svg>
    Sorry
  </div>
  <div>Lose</div>
  <div style="opacity:.7;margin-top:6px">3 seconds auto close</div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<script>
// ================== CONFIG & STATE ==================
// Use your existing project (kept from your earlier file so it's plug & play)
const firebaseConfig = {
  apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
  authDomain: "terminal-xxrr.firebaseapp.com",
  databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "terminal-xxrr",
  storageBucket: "terminal-xxrr.firebasestorage.app",
  messagingSenderId: "722753278120",
  appId: "1:722753278120:web:bfa37aab39635a4e57f29d",
  measurementId: "G-E3MZH3E1K5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Variants meta: each variant has its own synced anchor (startTs + periodStart)
const VARIANTS = { 30: true, 60: true, 180: true, 300: true };

// Your fixed starting period number:
const FIXED_START_PERIOD = 2025091000010250;

// UI / State
let variant = 30;            // seconds
let xMult = 1;               // bottom X multiplier for total
let pendingBet = null;       // {period,type,value,stake}
let page = 1;
const PAGE_SIZE = 10, MAX_PAGES = 50;
let tickTimer = null;
let meta = null;             // {startTs:number, periodStart:number, sec:number}
let lastPeriodStr = "";      // track last displayed period to handle resolution once

// ================== WALLET ==================
function loadWallet(){
  let w = parseFloat(localStorage.getItem('wallet')||'0');
  if(!w || isNaN(w)){ w = 100; localStorage.setItem('wallet', w.toFixed(2)); }
  updateBalance(w);
}
function updateBalance(v){
  localStorage.setItem('wallet', (+v).toFixed(2));
  document.getElementById('balance').textContent = '₹' + (+v).toFixed(2);
}
loadWallet();

// ================== UI BUILDERS ==================
const numsEl = document.getElementById('nums');
const numColor = (n)=>{
  if(n===0) return 'mix0'; if(n===5) return 'mix5';
  return [1,3,7,9].includes(n) ? 'green' : 'red';
};
for(let n=0;n<=9;n++){
  const d = document.createElement('div');
  d.className = 'ball ' + (n===0?'mix0': n===5?'mix5': numColor(n));
  d.textContent = n;
  d.onclick = ()=>openBet('NUM', n);
  numsEl.appendChild(d);
}

// Variant switching
document.querySelectorAll('.chip').forEach(ch=>{
  ch.onclick = ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    variant = +ch.dataset.variant;
    document.getElementById('vlabel').textContent = (variant===30?'30sec':variant===60?'1 Min':variant===180?'3 Min':'5 Min');
    document.getElementById('betTitle').textContent = `WinGo ${document.getElementById('vlabel').textContent}`;
    startSyncedSchedule(); // restart with new variant
  }
});

// Stake multiplier pills
document.querySelectorAll('.tag[data-m]').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tag[data-m]').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const m = t.dataset.m;
    xMult = (m==='RANDOM') ? [1,5,10,20,50,100][Math.floor(Math.random()*6)] : +m;
    refreshAmount();
  };
});

// ================== HELPERS ==================
function pad2(n){ return String(n).padStart(2,'0'); }
function formatMMSS(sec){
  sec = Math.max(0, Math.ceil(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return pad2(m)+":"+pad2(s)+" sec";
}
function getColors(n){
  if(n===0) return ['Red','Violet'];
  if(n===5) return ['Green','Violet'];
  if([1,3,7,9].includes(n)) return ['Green'];
  return ['Red'];
}
function showToast(id){
  const t = document.getElementById(id);
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 3000);
}
function refreshAmount(){
  const q = +document.getElementById('qty').value || 1;
  const total = q * xMult;
  document.getElementById('amount').textContent = total.toFixed(2);
}

// ================== SYNCED SCHEDULE (ANCHOR + AUTO INCREMENT) ==================
async function ensureMeta(){
  const ref = db.ref(`wingo/${variant}/meta`);
  // Transaction: set default anchor if missing
  await ref.transaction(curr=>{
    if(curr) return curr;
    // New anchor: start now, with fixed starting period
    return { startTs: Date.now(), periodStart: FIXED_START_PERIOD, sec: variant };
  });
  const snap = await ref.get();
  meta = snap.val();
}

function computeCurrentPeriodAndRemain(){
  const now = Date.now();
  const elapsedMs = now - meta.startTs;
  const cycle = meta.sec * 1000;
  const idx = Math.floor(elapsedMs / cycle);
  const remainMs = cycle - (elapsedMs % cycle);
  const currentPeriod = meta.periodStart + idx; // ✅ auto-incrementing period for all users
  return { currentPeriod, remainSec: Math.ceil(remainMs/1000) };
}

async function startSyncedSchedule(){
  if(tickTimer) clearInterval(tickTimer);
  await ensureMeta(); // make sure meta available

  // initial load of history
  await loadHistory();

  tickTimer = setInterval(async ()=>{
    const {currentPeriod, remainSec} = computeCurrentPeriodAndRemain();
    document.getElementById('count').textContent = formatMMSS(remainSec);
    document.getElementById('period').textContent = currentPeriod;

    // On flip (when period changed) resolve previous and load history
    if(lastPeriodStr === ""){
      lastPeriodStr = String(currentPeriod);
    }
    if(String(currentPeriod) !== lastPeriodStr){
      const prev = lastPeriodStr;
      // Ensure a result exists for previous (first writer wins)
      await ensureResult(prev);
      // Resolve bet for that period
      await resolveBet(prev);
      // Refresh recent history
      await loadHistory();
      // Optionally ensure current period result stub (not needed, we generate on close)
      lastPeriodStr = String(currentPeriod);
    }

    // When countdown hits zero, generate result for current period (first writer wins)
    if(remainSec === 1){ // 1 sec left → next tick will flip; prepare result at boundary if not yet there
      await ensureResult(currentPeriod);
    }
  }, 250);
}

// Ensure a single result per period across all users
async function ensureResult(periodStr){
  const ref = db.ref(`wingo/${variant}/results/${periodStr}`);
  const snap = await ref.get();
  if(snap.exists()) return;
  // Use transaction to avoid race
  await ref.transaction(curr=>{
    if(curr) return curr;
    const num = Math.floor(Math.random()*10);
    const bs = (num>=5)?'Big':'Small';
    const colors = getColors(num);
    return { num, bs, colors, ts: Date.now() };
  });
}

// Load latest history (50 rows max)
async function loadHistory(){
  const ref = db.ref(`wingo/${variant}/results`).limitToLast(PAGE_SIZE*5); // up to 50
  const snap = await ref.get();
  const rows = [];
  snap.forEach(ch=> rows.push({period: ch.key, ...ch.val()}));
  rows.sort((a,b)=> b.period.localeCompare(a.period)); // latest first
  const tb = document.querySelector('#history tbody');
  tb.innerHTML = '';
  rows.slice(0,50).forEach(it=>{
    const colorDots = it.colors.map(c=>`<span class="dot ${c.toLowerCase()}"></span>`).join(' ');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.period}</td>
      <td style="font-weight:800;color:${[1,3,7,9].includes(it.num)?'#22c55e':(it.num===0||it.num===5?'#8b5cf6':'#ef4444')}">${it.num}</td>
      <td>${it.bs}</td>
      <td>${colorDots}</td>`;
    tb.appendChild(tr);
  });
}

// ================== BETTING ==================
let betCtx = null; // {type:'BS'|'COLOR'|'NUM', value, theme}
function openBet(type, value){
  betCtx = {type, value, theme:'blue'};
  const sheet = document.getElementById('sheet');
  sheet.classList.remove('blue','orange');
  if(type==='BS'){
    sheet.classList.add(value==='Big'?'orange':'blue');
    betCtx.theme = (value==='Big')?'orange':'blue';
  }else if(type==='COLOR'){
    sheet.classList.add(value==='Red'?'orange':'blue');
    betCtx.theme = (value==='Red')?'orange':'blue';
  }else{
    sheet.classList.add([1,3,7,9].includes(value)?'blue':'orange');
    betCtx.theme = ([1,3,7,9].includes(value)?'blue':'orange');
  }
  document.getElementById('betTitle').textContent = `WinGo ${variant===30?'30sec':variant===60?'1 Min':variant===180?'3 Min':'5 Min'}`;
  document.getElementById('betSelection').textContent = (type==='NUM') ? `Select Number ${value}` : `Select ${value}`;
  xMult = 1;
  document.getElementById('qty').value = 1;
  refreshAmount();
  document.getElementById('betModal').style.display='flex';
}
function closeBet(){ document.getElementById('betModal').style.display='none'; }
function chgQty(d){
  const q = document.getElementById('qty');
  let v = Math.max(1, (+q.value||1)+d);
  q.value = v; refreshAmount();
}
function qtyMultiply(val){
  const q = document.getElementById('qty');
  q.value = Math.max(1, (+q.value||1) * val);
  refreshAmount();
}
function setX(n){ xMult = n; refreshAmount(); }

function placeBet(){
  if(!document.getElementById('agree').checked){ alert('Please agree to rules'); return; }
  if(!betCtx) return;
  const total = +document.getElementById('amount').textContent;
  let bal = parseFloat(localStorage.getItem('wallet')||'0');
  if(bal < total){ alert('Insufficient balance'); return; }
  // deduct now
  bal -= total; updateBalance(bal);

  // lock bet to the current synced period
  const {currentPeriod} = computeCurrentPeriodAndRemain();
  pendingBet = {period:String(currentPeriod), type:betCtx.type, value:betCtx.value, stake:total};
  showToast('betSuccess');
  closeBet();
}

// Resolve bet for a specific period using saved result
async function resolveBet(periodStr){
  if(!pendingBet || pendingBet.period !== String(periodStr)) return;
  const ref = db.ref(`wingo/${variant}/results/${periodStr}`);
  const snap = await ref.get();
  if(!snap.exists()){ pendingBet = null; return; }
  const res = snap.val(); // {num, bs, colors}
  const win = checkWin(pendingBet, res);
  if(win){
    const rate = (pendingBet.type==='NUM') ? 7.8 : 1.96;
    const prize = pendingBet.stake * rate;
    const bal = parseFloat(localStorage.getItem('wallet')||'0') + prize;
    updateBalance(bal);
    document.getElementById('winAmt').textContent = prize.toFixed(2);
    showToast('winToast');
  }else{
    showToast('loseToast');
  }
  pendingBet = null;
}

function checkWin(bet, res){
  if(bet.type==='BS') return bet.value===res.bs;
  if(bet.type==='COLOR') return res.colors.includes(bet.value);
  if(bet.type==='NUM') return (+bet.value)===res.num;
  return false;
}

// Pager placeholders (optional)
function prevPage(){}
function nextPage(){}

// ================== BOOT ==================
startSyncedSchedule();
</script>
</body>
</html>
               
